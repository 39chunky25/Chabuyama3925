<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>セラピスト精算アプリ（PWA）</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#4F46E5" />
  <!-- iOS用（任意）：同階層に icon-192.png を置く -->
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- スタイル（CDN） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    .tab-button.active { border-color: #4F46E5; color: #4F46E5; font-weight: 600; }
    .tab-button { transition: all 0.3s ease-in-out; }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
      border-color: #4F46E5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); outline: none;
    }
    .number-input-sm { width: 6rem; }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-50 to-indigo-100 min-h-screen flex flex-col items-center justify-center p-4 selection:bg-indigo-500 selection:text-white">

  <div id="app-container" class="container mx-auto max-w-4xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
    <header class="mb-8 text-center relative">
      <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-600">
        セラピスト精算アプリ
      </h1>
      <div class="absolute top-0 right-0 flex items-center space-x-2">
        <p id="userIdDisplay" class="text-xs text-gray-500">保存先: この端末のローカル</p>
      </div>
    </header>

    <div class="mb-6 border-b border-gray-200">
      <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
        <button data-tab="therapist-settings" class="tab-button active text-gray-600 hover:text-indigo-600 py-4 px-6 border-b-2 border-transparent font-medium text-sm sm:text-base focus:outline-none">
          セラピスト設定
        </button>
        <button data-tab="daily-settlement" class="tab-button text-gray-600 hover:text-indigo-600 py-4 px-6 border-b-2 border-transparent font-medium text-sm sm:text-base focus:outline-none">
          日次精算
        </button>
        <button data-tab="settlement-history" class="tab-button text-gray-600 hover:text-indigo-600 py-4 px-6 border-b-2 border-transparent font-medium text-sm sm:text-base focus:outline-none">
          精算履歴
        </button>
      </nav>
    </div>

    <div id="messageArea" class="mb-4 p-3 rounded-md text-sm hidden"></div>

    <main id="tabContent">
      <section id="therapist-settings" class="tab-pane active-tab space-y-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">セラピスト情報登録・編集</h2>
        <form id="therapistForm" class="space-y-4 p-6 bg-indigo-50 rounded-lg shadow">
          <div>
            <label for="therapistName" class="block text-sm font-medium text-gray-700">セラピスト名</label>
            <input type="text" id="therapistName" name="therapistName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">雑費タイプ</label>
            <div class="mt-1 flex space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="expenseType" value="fixed" class="form-radio h-4 w-4 text-indigo-600 border-gray-300" checked>
                <span class="ml-2 text-gray-700">固定</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="expenseType" value="percentage" class="form-radio h-4 w-4 text-indigo-600 border-gray-300">
                <span class="ml-2 text-gray-700">歩合 (10%)</span>
              </label>
            </div>
          </div>
          <div id="fixedExpenseAmountContainer">
            <label for="expenseValueFixed" class="block text-sm font-medium text-gray-700">雑費金額 (固定の場合)</label>
            <input type="number" id="expenseValueFixed" name="expenseValueFixed" value="1000" min="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
          </div>
          <input type="hidden" id="therapistId" name="therapistId">
          <div class="flex space-x-2">
            <button type="submit" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
              登録・更新
            </button>
            <button type="button" id="clearTherapistFormButton" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
              クリア
            </button>
          </div>
        </form>

        <div class="mt-8">
          <h3 class="text-lg font-medium text-gray-700 mb-3">登録済みセラピスト一覧</h3>
          <div id="therapistList" class="space-y-3 max-h-60 overflow-y-auto p-1">
            <p class="text-gray-500">セラピスト情報がありません。登録してください。</p>
          </div>
        </div>
      </section>

      <section id="daily-settlement" class="tab-pane hidden space-y-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">日次精算入力</h2>
        <form id="settlementForm" class="space-y-6 p-6 bg-purple-50 rounded-lg shadow">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="settlementDate" class="block text-sm font-medium text-gray-700">精算日</label>
              <input type="date" id="settlementDate" name="settlementDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
            </div>
            <div>
              <label for="settlementTherapist" class="block text-sm font-medium text-gray-700">セラピスト</label>
              <select id="settlementTherapist" name="settlementTherapist" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm sm:text-sm">
                <option value="">セラピストを選択</option>
              </select>
            </div>
          </div>
          
          <div class="pt-4 border-t border-gray-200">
            <div id="customerSettlementsContainer" class="space-y-6"></div>
            <div class="mt-4">
              <button type="button" id="addCustomerButton" class="w-full inline-flex justify-center py-2 px-4 border border-dashed border-indigo-400 text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                お客様の精算を追加
              </button>
            </div>
          </div>

          <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-medium text-gray-700">【集計】報酬計算結果</h3>
            <div class="mt-2 space-y-1 text-sm text-gray-600">
              <p>コース売上(バック対象): <span id="courseSalesForRewardDisplay" class="font-semibold">0円</span></p>
              <p>延長売上(バック対象): <span id="extensionSalesForRewardDisplay" class="font-semibold">0円</span></p>
              <p>オプション売上(全額バック): <span id="optionSalesForRewardDisplay" class="font-semibold">0円</span></p>
              <p>本指名追加報酬: <span id="nominationBonusDisplay" class="font-semibold">0円</span></p>
              <p>報酬対象売上合計: <span id="totalRewardableSalesDisplay" class="font-semibold">0円</span></p>
              <p>雑費: <span id="expensesDisplay" class="font-semibold">0円</span></p>
              <p class="text-base">確定報酬額: <span id="netRewardDisplay" class="font-bold text-indigo-600 text-lg">0円</span></p>
            </div>
          </div>

          <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-medium text-gray-700">【集計】レジ精算</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
              <div>
                <label for="openingCash" class="block text-sm font-medium text-gray-700">業務開始時レジ金額</label>
                <input type="number" id="openingCash" name="openingCash" min="0" value="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="例: 50000">
              </div>
              <div>
                <label for="cashSales" class="block text-sm font-medium text-gray-700">お客様からの現金支払額 (合計)</label>
                <input type="number" id="cashSales" name="cashSales" min="0" value="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="例: 20000">
              </div>
            </div>
            <div class="mt-4 text-sm text-gray-600">
              <p class="text-base">最終レジ残金: <span id="closingBalanceDisplay" class="font-bold text-green-600 text-lg">0円</span></p>
            </div>
          </div>

          <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-medium text-gray-700">【集計】精算内容テキスト (コピー用)</h3>
            <textarea id="settlementTextOutput" rows="12" readonly class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-xs font-mono"></textarea>
            <button type="button" id="copySettlementTextButton" class="mt-2 inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              テキストをコピー
            </button>
          </div>

          <div class="flex space-x-2 pt-6">
            <button type="submit" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition">
              精算記録を保存
            </button>
            <button type="button" id="clearSettlementFormButton" class="w-full sm:w-auto inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
              入力クリア
            </button>
          </div>
        </form>
      </section>

      <section id="settlement-history" class="tab-pane hidden space-y-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">精算履歴</h2>
        <div class="overflow-x-auto bg-white rounded-lg shadow">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">日付</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">セラピスト</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">確定報酬額</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">最終レジ残金</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">アクション</th>
              </tr>
            </thead>
            <tbody id="settlementHistoryTableBody" class="bg-white divide-y divide-gray-200">
              <tr><td colspan="5" class="px-4 py-4 text-sm text-gray-500 text-center">精算履歴はありません。</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ====== 設定 ======
    const COURSE_PRICES = { '60': 14000, '90': 18000, '120': 23000 };
    const STORAGE = { THERAPISTS: 'therapists_v1', SETTLEMENTS: 'settlements_v4' };

    // ====== 共通UI ======
    const messageArea = document.getElementById('messageArea');
    function showMessage(message, type = 'success') {
      messageArea.textContent = message;
      messageArea.className = `mb-4 p-3 rounded-md text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
      messageArea.classList.remove('hidden');
      setTimeout(() => messageArea.classList.add('hidden'), 4000);
    }
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(amount || 0);
    }
    function getDayOfWeek(date) {
      const days = ['日', '月', '火', '水', '木', '金', '土'];
      return days[new Date(date).getDay()];
    }

    // ====== タブ制御 ======
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const targetTab = button.dataset.tab;
        tabPanes.forEach(pane => {
          pane.id === targetTab ? pane.classList.remove('hidden') : pane.classList.add('hidden');
        });
        if (targetTab === 'daily-settlement') populateSettlementTherapistSelect();
        if (targetTab === 'settlement-history') loadSettlementHistory();
      });
    });

    // ====== ローカル保存ユーティリティ ======
    function loadLocal(key, fallback) {
      try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : (fallback ?? null); }
      catch(e){ console.error('loadLocal error', key, e); return (fallback ?? null); }
    }
    function saveLocal(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); }
      catch(e){ console.error('saveLocal error', key, e); showMessage('保存に失敗しました（容量制限など）。', 'error'); }
    }
    function uid() { return 'id_' + Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

    // ====== セラピスト設定 ======
    const therapistForm = document.getElementById('therapistForm');
    const therapistNameInput = document.getElementById('therapistName');
    const expenseTypeRadios = document.querySelectorAll('input[name="expenseType"]');
    const fixedExpenseAmountContainer = document.getElementById('fixedExpenseAmountContainer');
    const expenseValueFixedInput = document.getElementById('expenseValueFixed');
    const therapistIdInput = document.getElementById('therapistId');
    const therapistListDiv = document.getElementById('therapistList');
    const clearTherapistFormButton = document.getElementById('clearTherapistFormButton');

    let therapists = loadLocal(STORAGE.THERAPISTS, []);

    expenseTypeRadios.forEach(radio => radio.addEventListener('change', (e) => {
      fixedExpenseAmountContainer.classList.toggle('hidden', e.target.value !== 'fixed');
      expenseValueFixedInput.required = e.target.value === 'fixed';
    }));
    if (document.querySelector('input[name="expenseType"]:checked').value === 'fixed') {
      fixedExpenseAmountContainer.classList.remove('hidden');
      expenseValueFixedInput.required = true;
    } else {
      fixedExpenseAmountContainer.classList.add('hidden');
      expenseValueFixedInput.required = false;
    }

    function renderTherapists() {
      therapistListDiv.innerHTML = '';
      if (!therapists || therapists.length === 0) {
        therapistListDiv.innerHTML = '<p class="text-gray-500">登録セラピストがいません。</p>';
        populateSettlementTherapistSelect();
        return;
      }
      therapists.forEach(t => {
        const div = document.createElement('div');
        div.className = 'p-3 bg-white border border-gray-200 rounded-md shadow-sm flex justify-between items-center';
        const expenseDisplay = t.expenseType === 'fixed'
          ? `固定: ${formatCurrency(t.expenseValue)}`
          : `歩合: ${(t.expenseValue * 100).toFixed(0)}%`;
        div.innerHTML = `
          <div>
            <p class="font-medium text-gray-800">${t.name}</p>
            <p class="text-xs text-gray-500">${expenseDisplay}</p>
          </div>
          <div class="space-x-2">
            <button data-id="${t.id}" class="edit-therapist-btn text-xs py-1 px-2 rounded bg-yellow-400 hover:bg-yellow-500 text-white transition">編集</button>
            <button data-id="${t.id}" class="delete-therapist-btn text-xs py-1 px-2 rounded bg-red-500 hover:bg-red-600 text-white transition">削除</button>
          </div>`;
        therapistListDiv.appendChild(div);
      });
      populateSettlementTherapistSelect();
    }

    therapistForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = therapistNameInput.value.trim();
      const expenseType = document.querySelector('input[name="expenseType"]:checked').value;
      const expenseValue = expenseType === 'fixed' ? parseFloat(expenseValueFixedInput.value) : 0.10;
      const id = therapistIdInput.value || uid();

      if (!name) return showMessage('セラピスト名を入力してください。', 'error');
      if (expenseType === 'fixed' && (isNaN(expenseValue) || expenseValue < 0)) return showMessage('有効な雑費金額を入力してください。', 'error');

      const existingIdx = therapists.findIndex(t => t.id === id);
      const data = { id, name, expenseType, expenseValue, updatedAt: Date.now(), createdAt: existingIdx >= 0 ? therapists[existingIdx].createdAt : Date.now() };
      if (existingIdx >= 0) {
        therapists[existingIdx] = data;
        showMessage('セラピスト情報を更新しました。');
      } else {
        therapists.unshift(data);
        showMessage('セラピストを登録しました。');
      }
      saveLocal(STORAGE.THERAPISTS, therapists);
      therapistForm.reset();
      therapistIdInput.value = '';
      document.querySelector('input[name="expenseType"][value="fixed"]').checked = true;
      fixedExpenseAmountContainer.classList.remove('hidden');
      expenseValueFixedInput.value = "1000";
      renderTherapists();
    });

    clearTherapistFormButton.addEventListener('click', () => {
      therapistForm.reset();
      therapistIdInput.value = '';
      document.querySelector('input[name="expenseType"][value="fixed"]').checked = true;
      fixedExpenseAmountContainer.classList.remove('hidden');
      expenseValueFixedInput.value = "1000";
      therapistNameInput.focus();
    });

    therapistListDiv.addEventListener('click', (e) => {
      const target = e.target;
      const id = target.dataset.id;
      if (!id) return;
      const t = therapists.find(x => x.id === id);
      if (!t) return;

      if (target.classList.contains('edit-therapist-btn')) {
        therapistNameInput.value = t.name;
        document.querySelector(`input[name="expenseType"][value="${t.expenseType}"]`).checked = true;
        fixedExpenseAmountContainer.classList.toggle('hidden', t.expenseType !== 'fixed');
        if (t.expenseType === 'fixed') expenseValueFixedInput.value = t.expenseValue;
        therapistIdInput.value = t.id;
        therapistNameInput.focus();
      } else if (target.classList.contains('delete-therapist-btn')) {
        therapists = therapists.filter(x => x.id !== id);
        saveLocal(STORAGE.THERAPISTS, therapists);
        showMessage('セラピストを削除しました。');
        if (therapistIdInput.value === id) { therapistForm.reset(); therapistIdInput.value = ''; }
        renderTherapists();
      }
    });

    function populateSettlementTherapistSelect() {
      const select = document.getElementById('settlementTherapist');
      const currentVal = select.value;
      select.innerHTML = '<option value="">セラピストを選択</option>';
      if (!therapists || therapists.length === 0) {
        select.innerHTML = '<option value="">まずセラピストを登録してください</option>';
      } else {
        therapists.forEach(t => {
          const option = document.createElement('option');
          option.value = t.id; option.textContent = t.name;
          option.dataset.expenseType = t.expenseType;
          option.dataset.expenseValue = t.expenseValue;
          select.appendChild(option);
        });
      }
      select.value = currentVal;
    }

    // ====== 日次精算 ======
    const settlementFormEl = document.getElementById('settlementForm');
    const settlementDateInput = document.getElementById('settlementDate');
    const settlementTherapistSelect = document.getElementById('settlementTherapist');
    const customerSettlementsContainer = document.getElementById('customerSettlementsContainer');
    const addCustomerButton = document.getElementById('addCustomerButton');
    const openingCashInput = document.getElementById('openingCash');
    const cashSalesInput = document.getElementById('cashSales');

    const courseSalesForRewardDisplay = document.getElementById('courseSalesForRewardDisplay');
    const extensionSalesForRewardDisplay = document.getElementById('extensionSalesForRewardDisplay');
    const optionSalesForRewardDisplay = document.getElementById('optionSalesForRewardDisplay');
    const nominationBonusDisplay = document.getElementById('nominationBonusDisplay');
    const totalRewardableSalesDisplay = document.getElementById('totalRewardableSalesDisplay');
    const expensesDisplay = document.getElementById('expensesDisplay');
    const netRewardDisplay = document.getElementById('netRewardDisplay');
    const closingBalanceDisplay = document.getElementById('closingBalanceDisplay');
    const settlementTextOutput = document.getElementById('settlementTextOutput');
    const copySettlementTextButton = document.getElementById('copySettlementTextButton');
    const clearSettlementFormButton = document.getElementById('clearSettlementFormButton');

    let customerSettlementCounter = 0;
    settlementDateInput.valueAsDate = new Date();

    function addCustomerSettlementBlock() {
      customerSettlementCounter++;
      const blockId = customerSettlementCounter;

      const block = document.createElement('div');
      block.className = 'customer-settlement-block p-4 border border-gray-300 rounded-lg bg-white relative';
      block.dataset.blockId = blockId;

      block.innerHTML = `
        <button type="button" class="remove-customer-block-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
        </button>
        <h4 class="text-md font-semibold text-gray-800 mb-3">お客様 ${blockId}</h4>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">指名タイプ</label>
          <div class="flex space-x-4">
            <label class="inline-flex items-center">
              <input type="radio" name="nominationType_${blockId}" value="free_photo" class="form-radio h-4 w-4 text-indigo-600 border-gray-300" checked>
              <span class="ml-2 text-gray-700 text-sm">フリー/写真 (50%)</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="nominationType_${blockId}" value="full_nomination" class="form-radio h-4 w-4 text-indigo-600 border-gray-300">
              <span class="ml-2 text-gray-700 text-sm">本指名 (60%)</span>
            </label>
          </div>
        </div>

        <div class="space-y-3 pt-4 mt-4 border-t border-gray-200">
          <h3 class="text-sm font-medium text-gray-700">コース入力</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <div>
              <label class="block text-xs font-medium text-gray-600">60分 (¥14,000)</label>
              <input type="number" name="course60Count" min="0" value="0" class="mt-1 block w-full number-input-sm px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="本数">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600">90分 (¥18,000)</label>
              <input type="number" name="course90Count" min="0" value="0" class="mt-1 block w-full number-input-sm px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="本数">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600">120分 (¥23,000)</label>
              <input type="number" name="course120Count" min="0" value="0" class="mt-1 block w-full number-input-sm px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="本数">
            </div>
          </div>
        </div>

        <div class="space-y-3 pt-4 mt-4 border-t border-gray-200">
          <h3 class="text-sm font-medium text-gray-700">その他入力</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <div>
              <label class="block text-xs font-medium text-gray-600">延長料金 (総額)</label>
              <input type="number" name="extensionFeeTotal" min="0" value="0" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="¥ 金額">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600">オプション代 (総額)</label>
              <input type="number" name="optionFeeTotal" min="0" value="0" class="mt-1 block w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="¥ 金額">
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600">本指名本数 (追加報酬)</label>
              <input type="number" name="fullNominationCount" min="0" value="0" class="mt-1 block w-full number-input-sm px-2 py-1 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="本数">
            </div>
          </div>
        </div>`;
      customerSettlementsContainer.appendChild(block);

      block.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('input', calculateSettlement);
        input.addEventListener('change', calculateSettlement);
      });
    }
    addCustomerButton.addEventListener('click', addCustomerSettlementBlock);
    customerSettlementsContainer.addEventListener('click', (e) => {
      if (e.target.closest('.remove-customer-block-btn')) {
        e.target.closest('.customer-settlement-block').remove();
        calculateSettlement();
      }
    });

    function calculateSettlement() {
      const grandTotal = {
        courseReward: 0, totalCourseSales: 0, extensionReward: 0, totalExtensionSales: 0,
        optionReward: 0, nominationBonus: 0, course60Count: 0, course90Count: 0,
        course120Count: 0, fullNominationCount: 0, extensionCount: 0, optionCount: 0
      };
      const settlementBlocks = document.querySelectorAll('.customer-settlement-block');

      settlementBlocks.forEach(block => {
        const nominationType = block.querySelector('input[name^="nominationType_"]:checked').value;
        const backupRate = nominationType === 'full_nomination' ? 0.60 : 0.50;

        const c60 = parseInt(block.querySelector('[name="course60Count"]').value) || 0;
        const c90 = parseInt(block.querySelector('[name="course90Count"]').value) || 0;
        const c120 = parseInt(block.querySelector('[name="course120Count"]').value) || 0;

        grandTotal.course60Count += c60;
        grandTotal.course90Count += c90;
        grandTotal.course120Count += c120;

        const blockCourseSales = (c60 * COURSE_PRICES['60']) + (c90 * COURSE_PRICES['90']) + (c120 * COURSE_PRICES['120']);
        grandTotal.totalCourseSales += blockCourseSales;
        grandTotal.courseReward += blockCourseSales * backupRate;

        const blockExtensionFee = parseFloat(block.querySelector('[name="extensionFeeTotal"]').value) || 0;
        grandTotal.totalExtensionSales += blockExtensionFee;
        grandTotal.extensionReward += blockExtensionFee * backupRate;
        if (blockExtensionFee > 0) grandTotal.extensionCount++;

        const blockOptionFee = parseFloat(block.querySelector('[name="optionFeeTotal"]').value) || 0;
        grandTotal.optionReward += blockOptionFee;
        if (blockOptionFee > 0) grandTotal.optionCount++;

        const blockNominationCount = parseInt(block.querySelector('[name="fullNominationCount"]').value) || 0;
        grandTotal.fullNominationCount += blockNominationCount;
        grandTotal.nominationBonus += blockNominationCount * 1000;
      });

      const backupRateText = grandTotal.totalCourseSales > 0 ? ` (${formatCurrency(grandTotal.totalCourseSales)}の平均バック)` : '';
      courseSalesForRewardDisplay.textContent = formatCurrency(grandTotal.courseReward) + backupRateText;
      const extensionBackupRateText = grandTotal.totalExtensionSales > 0 ? ` (${formatCurrency(grandTotal.totalExtensionSales)}の平均バック)` : '';
      extensionSalesForRewardDisplay.textContent = formatCurrency(grandTotal.extensionReward) + extensionBackupRateText;
      optionSalesForRewardDisplay.textContent = formatCurrency(grandTotal.optionReward);
      nominationBonusDisplay.textContent = formatCurrency(grandTotal.nominationBonus);

      const totalRewardBeforeExpenses = grandTotal.courseReward + grandTotal.extensionReward + grandTotal.optionReward + grandTotal.nominationBonus;
      totalRewardableSalesDisplay.textContent = formatCurrency(totalRewardBeforeExpenses);

      let expenses = 0;
      const selectedTherapistOption = settlementTherapistSelect.options[settlementTherapistSelect.selectedIndex];
      if (selectedTherapistOption && selectedTherapistOption.value) {
        const therapistExpenseType = selectedTherapistOption.dataset.expenseType;
        const therapistExpenseValue = parseFloat(selectedTherapistOption.dataset.expenseValue);
        if (therapistExpenseType === 'fixed') {
          expenses = therapistExpenseValue;
        } else if (therapistExpenseType === 'percentage') {
          expenses = totalRewardBeforeExpenses * therapistExpenseValue;
        }
      }
      expensesDisplay.textContent = formatCurrency(expenses);

      const rawNetReward = totalRewardBeforeExpenses - expenses;
      const netReward = Math.round(rawNetReward / 1000) * 1000;
      netRewardDisplay.textContent = formatCurrency(netReward);

      const openingCash = parseFloat(openingCashInput.value) || 0;
      const cashSales = parseFloat(cashSalesInput.value) || 0;
      const closingBalance = openingCash + cashSales - netReward;
      closingBalanceDisplay.textContent = formatCurrency(closingBalance);

      generateSettlementText(grandTotal);
      return { totalRewardBeforeExpenses, expenses, netReward, closingBalance };
    }

    // === ここから追記：テキスト用にコース別のバック合計を算出するヘルパー ===
    function computePerCourseRewardAndCount() {
      const result = {
        '60':  { count: 0, reward: 0 },
        '90':  { count: 0, reward: 0 },
        '120': { count: 0, reward: 0 }
      };

      const blocks = document.querySelectorAll('.customer-settlement-block');
      blocks.forEach(block => {
        const nominationType = block.querySelector('input[name^="nominationType_"]:checked')?.value || 'free_photo';
        const rate = nominationType === 'full_nomination' ? 0.60 : 0.50;

        const c60  = parseInt(block.querySelector('[name="course60Count"]')?.value || '0', 10);
        const c90  = parseInt(block.querySelector('[name="course90Count"]')?.value || '0', 10);
        const c120 = parseInt(block.querySelector('[name="course120Count"]')?.value || '0', 10);

        if (c60  > 0) { result['60'].count  += c60;  result['60'].reward  += c60  * COURSE_PRICES['60']  * rate; }
        if (c90  > 0) { result['90'].count  += c90;  result['90'].reward  += c90  * COURSE_PRICES['90']  * rate; }
        if (c120 > 0) { result['120'].count += c120; result['120'].reward += c120 * COURSE_PRICES['120'] * rate; }
      });

      ['60','90','120'].forEach(k => result[k].reward = Math.round(result[k].reward));
      return result;
    }
    // === 追記ここまで ===

    [settlementTherapistSelect, openingCashInput, cashSalesInput].forEach(input => {
      input.addEventListener('input', calculateSettlement);
      input.addEventListener('change', calculateSettlement);
    });

    // === テキスト出力関数：指名タイプ（50%/60%）×コース料金の合計で表示 ===
    function generateSettlementText(totals) {
      const dateVal = settlementDateInput.value;
      if (!dateVal) { settlementTextOutput.value = "日付を選択してください。"; return; }
      const dayOfWeek = getDayOfWeek(dateVal);
      const formattedDate = `${new Date(dateVal).getMonth() + 1}/${new Date(dateVal).getDate()}(${dayOfWeek})`;

      const perCourse = computePerCourseRewardAndCount();

      const extFee = totals.totalExtensionSales; const extCount = totals.extensionCount;
      const opFee = totals.optionReward; const opCount = totals.optionCount;
      const nomCount = totals.fullNominationCount; const nomFee = totals.nominationBonus;

      const expenseYen = parseFloat(expensesDisplay.textContent.replace(/[^0-9.-]+/g,"")) || 0;
      const opening = parseFloat(openingCashInput.value) || 0;
      const cashIn = parseFloat(cashSalesInput.value) || 0;
      const totalCash = opening + cashIn;
      const therapistReward = parseFloat(netRewardDisplay.textContent.replace(/[^0-9.-]+/g,"")) || 0;
      const closing = parseFloat(closingBalanceDisplay.textContent.replace(/[^0-9.-]+/g,"")) || 0;

      const line60  = `60分×${perCourse['60'].count} ¥${perCourse['60'].reward.toLocaleString()}`;
      const line90  = `90分×${perCourse['90'].count} ¥${perCourse['90'].reward.toLocaleString()}`;
      const line120 = `120分×${perCourse['120'].count} ¥${perCourse['120'].reward.toLocaleString()}`;

      const text = `${formattedDate}
${line60}
${line90}
${line120}
延長×${extCount} ¥${extFee.toLocaleString()}
OP×${opCount} ¥${opFee.toLocaleString()}
本指名×${nomCount} ¥${nomFee.toLocaleString()}
雑費▲¥${expenseYen.toLocaleString()}

入室前レジ金¥${opening.toLocaleString()}
現金売上¥${cashIn.toLocaleString()}
レジ金合計¥${totalCash.toLocaleString()}

セラピスト報酬 ¥${therapistReward.toLocaleString()}
退室時レジ金¥${closing.toLocaleString()}`.trim();
      settlementTextOutput.value = text;
    }

    // クリップボード：HTTPSならClipboard API、なければフォールバック
    const settlementHistoryTableBody = document.getElementById('settlementHistoryTableBody');
    const copySettlementTextButton = document.getElementById('copySettlementTextButton');
    copySettlementTextButton.addEventListener('click', async () => {
      const text = settlementTextOutput.value;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          showMessage('テキストをコピーしました！');
        } else {
          settlementTextOutput.select();
          const ok = document.execCommand('copy');
          window.getSelection().removeAllRanges();
          showMessage(ok ? 'テキストをコピーしました！' : 'コピーに失敗しました。');
        }
      } catch(e) {
        showMessage('コピーに失敗しました。', 'error');
      }
    });

    // ====== 履歴（ローカル保存） ======
    function renderSettlementHistory(list) {
      settlementHistoryTableBody.innerHTML = '';
      if (!list || list.length === 0) {
        settlementHistoryTableBody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-sm text-gray-500 text-center">精算履歴はありません。</td></tr>';
        return;
      }
      list.forEach(s => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50 transition-colors duration-150";
        tr.innerHTML = `
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${new Date(s.date).toLocaleDateString()}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${s.therapistName}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(s.netReward)}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-green-700 font-medium">${formatCurrency(s.closingBalance)}</td>
          <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
            <button data-id="${s.id}" class="delete-settlement-btn text-xs py-1 px-2 rounded bg-red-500 hover:bg-red-600 text-white transition">削除</button>
          </td>`;
        settlementHistoryTableBody.appendChild(tr);
      });
    }
    function loadSettlementHistory() {
      const list = loadLocal(STORAGE.SETTLEMENTS, []);
      renderSettlementHistory(list);
    }
    settlementHistoryTableBody.addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-settlement-btn')) {
        const id = e.target.dataset.id;
        const list = loadLocal(STORAGE.SETTLEMENTS, []);
        const filtered = list.filter(x => x.id !== id);
        saveLocal(STORAGE.SETTLEMENTS, filtered);
        showMessage('精算記録を削除しました。');
        renderSettlementHistory(filtered);
      }
    });

    const clearSettlementFormButton = document.getElementById('clearSettlementFormButton');
    const settlementFormElRef = document.getElementById('settlementForm'); // alias
    settlementFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const settlementDate = settlementDateInput.value;
      const therapistId = settlementTherapistSelect.value;
      const therapistName = settlementTherapistSelect.options[settlementTherapistSelect.selectedIndex]?.text;

      if (!settlementDate || !therapistId) return showMessage('日付とセラピストを選択してください。', 'error');

      const customerEntries = [];
      document.querySelectorAll('.customer-settlement-block').forEach(block => {
        customerEntries.push({
          nominationType: block.querySelector('input[name^="nominationType_"]:checked').value,
          course60Count: parseInt(block.querySelector('[name="course60Count"]').value) || 0,
          course90Count: parseInt(block.querySelector('[name="course90Count"]').value) || 0,
          course120Count: parseInt(block.querySelector('[name="course120Count"]').value) || 0,
          extensionFeeTotal: parseFloat(block.querySelector('[name="extensionFeeTotal"]').value) || 0,
          optionFeeTotal: parseFloat(block.querySelector('[name="optionFeeTotal"]').value) || 0,
          fullNominationCount: parseInt(block.querySelector('[name="fullNominationCount"]').value) || 0,
        });
      });
      if (customerEntries.length === 0) return showMessage('精算するお客様情報がありません。', 'error');

      const calcResult = calculateSettlement();
      const settlementData = {
        id: uid(),
        date: new Date(settlementDate).getTime(),
        therapistId, therapistName,
        customerEntries,
        totalRewardBeforeExpenses: calcResult.totalRewardBeforeExpenses,
        expenses: calcResult.expenses, netReward: calcResult.netReward,
        openingCash: parseFloat(openingCashInput.value) || 0,
        cashSales: parseFloat(cashSalesInput.value) || 0,
        closingBalance: calcResult.closingBalance,
        settlementText: document.getElementById('settlementTextOutput').value,
        createdAt: Date.now()
      };
      const list = loadLocal(STORAGE.SETTLEMENTS, []);
      list.unshift(settlementData);
      saveLocal(STORAGE.SETTLEMENTS, list);
      showMessage('精算記録を保存しました。');
      clearSettlementFormButton.click();
    });

    clearSettlementFormButton.addEventListener('click', () => {
      settlementFormEl.reset();
      settlementDateInput.valueAsDate = new Date();
      customerSettlementsContainer.innerHTML = '';
      addCustomerSettlementBlock();
      calculateSettlement();
      settlementTherapistSelect.focus();
    });

    // ====== 初期化 ======
    function main(){
      renderTherapists();
      document.querySelector('.tab-button[data-tab="therapist-settings"]').click();
      addCustomerSettlementBlock();
      calculateSettlement();
    }
    document.addEventListener('DOMContentLoaded', main);

    // ====== Service Worker登録（GitHub Pages用に相対パスでOK） ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => {
          console.warn('ServiceWorker registration failed:', err);
        });
      });
    }
  </script>
</body>
</html>
